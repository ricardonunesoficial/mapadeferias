<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de F√©rias - Auchan & Closer</title>

  <style>
    /* 
       ALL CSS REMAINS EXACTLY THE SAME AS YOUR ORIGINAL CODE 
    */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
    .container { max-width: 100%; background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3); overflow: hidden; }
    .header { background: linear-gradient(135deg, #1F4E78 0%, #2d5a8c 100%); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .header p { font-size: 16px; opacity: 0.9; }
    .controls { padding: 25px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
    .year-selector { display: flex; gap: 10px; align-items: center; }
    .year-selector label { font-weight: bold; color: #333; }
    select { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white; cursor: pointer; min-width: 100px; }
    select:focus { outline: none; border-color: #4472C4; box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1); }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, #00B050, #009040); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 176, 80, 0.4); }
    .btn-export { background: linear-gradient(135deg, #4472C4, #2d5aa6); color: white; }
    .btn-export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(68, 114, 196, 0.4); }
    .btn-clear { background: linear-gradient(135deg, #FF6B6B, #EE5A52); color: white; }
    .stats { display: flex; gap: 20px; margin-left: auto; flex-wrap: wrap; }
    .stat-item { display: flex; gap: 8px; align-items: center; padding: 8px 15px; background: white; border-radius: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .stat-label { font-weight: 600; color: #666; font-size: 13px; }
    .stat-value { background: linear-gradient(135deg, #00B050, #009040); color: white; padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 14px; }
    .timeline-wrapper { overflow-x: auto; overflow-y: auto; max-height: 70vh; border-bottom: 2px solid #e0e0e0; }
    .timeline-table { border-collapse: collapse; width: 100%; font-size: 10px; }
    .timeline-table th { background: linear-gradient(135deg, #1F4E78, #2d5a8c); color: white !important; padding: 8px 4px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 20; border-right: 1px solid rgba(255,255,255,0.2); line-height: 1.1; height: 42px; }
    .timeline-table th:first-child { position: sticky; left: 0; z-index: 21; border-right: 3px solid rgba(255,255,255,0.3); text-align: left; padding-left: 12px; font-size: 11px; }
    .day-header { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .month-abbr { font-size: 7px; margin-bottom: 1px; opacity: 0.9; }
    .day-number { font-size: 10px; }
    .weekday-bottom { font-size: 6px !important; opacity: 0.85; line-height: 1; margin-top: 0.5px; font-weight: 600; text-shadow: 0 0.5px 1px rgba(0,0,0,0.4); }
    .timeline-table td { border-right: 1px solid #eee; padding: 4px 2px; text-align: center; cursor: pointer; user-select: none; min-width: 38px; height: 38px; transition: all 0.2s ease; color: white !important; font-weight: bold; font-size: 11px; }
    .timeline-table td:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .timeline-table td:first-child { position: sticky; left: 0; background: linear-gradient(135deg, #4472C4, #5981d6) !important; color: white !important; font-weight: bold; z-index: 15; border-right: 3px solid #2d5aa6 !important; padding-left: 12px; text-align: left; font-size: 12px; }
    .timeline-table tr:nth-child(even) td:first-child { background: linear-gradient(135deg, #5981d6, #4472C4) !important; }
    .cell-empty { background: #ffffff; color: #999 !important; }
    .cell-f { background: linear-gradient(135deg, #00B050, #009040) !important; color: white !important; }
    .cell-m { background: linear-gradient(135deg, #92D050, #7bb854) !important; color: white !important; }
    .cell-t { background: linear-gradient(135deg, #FFC000, #ffb300) !important; color: white !important; }
    .cell-feriado-ano-novo { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-liberdade { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-trabalhador { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-portugal { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-assuncao { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-republica { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-todos-santos { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-restauracao { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-imaculada { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-natal { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-sexta-santa { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-pascoa { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-feriado-corpus-christi { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-holiday { background: linear-gradient(135deg, #DC143C, #B22222) !important; color: white !important; }
    .cell-weekend { background: linear-gradient(135deg, #f0f0f0, #e0e0e0) !important; color: #666 !important; }
    .resumo { padding: 30px; background: #f8f9fa; }
    .resumo h2 { background: linear-gradient(135deg, #4472C4, #2d5aa6); color: white; padding: 20px; margin-bottom: 25px; border-radius: 10px; text-align: center; font-size: 24px; }
    .resumo-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .resumo-table th { background: linear-gradient(135deg, #4472C4, #2d5aa6); color: white; padding: 15px; text-align: left; font-weight: bold; font-size: 14px; }
    .resumo-table td { border-bottom: 1px solid #eee; padding: 15px; text-align: center; font-size: 16px; }
    .resumo-table tr:nth-child(even) { background: #ffffff; }
    .resumo-table tr:hover { background: #e8f4f8; }
    .resumo-table td:first-child { text-align: left; font-weight: bold; color: #1F4E78; font-size: 15px; }
    .cell-calc { background: linear-gradient(135deg, #E7E6E6, #d0d0d0) !important; font-weight: bold; }
    .cell-editable { background: linear-gradient(135deg, #FFF2CC, #FFE599) !important; cursor: pointer; font-weight: bold; border: 2px solid #FFC000 !important; }
    .legend { background: white; padding: 25px; border-radius: 10px; border: 2px solid #e0e0e0; margin-top: 25px; }
    .legend h3 { margin-bottom: 20px; color: #1F4E78; font-size: 20px; text-align: center; }
    .legend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .legend-item { display: flex; align-items: center; gap: 12px; font-size: 13px; }
    .legend-color { width: 25px; height: 25px; border-radius: 5px; border: 2px solid #333; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: linear-gradient(135deg, white 0%, #f8f9fa 100%); padding: 40px; border-radius: 20px; text-align: center; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); }
    .modal-content h2 { margin-bottom: 15px; color: #1F4E78; font-size: 24px; }
    .modal-info { background: #e8f4f8; padding: 15px; border-radius: 10px; margin-bottom: 25px; font-size: 16px; border-left: 5px solid #4472C4; text-align: left; }
    .modal-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 25px; }
    .modal-buttons button { padding: 15px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px; transition: all 0.3s ease; text-transform: uppercase; }
    .btn-f { background: linear-gradient(135deg, #00B050, #009040); color: white; }
    .btn-m { background: linear-gradient(135deg, #92D050, #7bb854); color: white; }
    .btn-t { background: linear-gradient(135deg, #FFC000, #ffb300); color: white; }
    .btn-cancel { background: #999; color: white; }
    .btn-f:hover, .btn-m:hover, .btn-t:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } .stats { margin-left: 0; justify-content: center; } .modal-buttons { grid-template-columns: 1fr; } .legend-grid { grid-template-columns: 1fr; } .timeline-table th { padding: 6px 3px; height: 38px; } .weekday-bottom { font-size: 5.5px !important; } }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Mapa de F√©rias</h1>
      <p>Time Line Interativo - Auchan & Closer Team</p>
    </div>

    <div class="controls">
      <div class="year-selector">
        <label>üìÖ Ano:</label>
        <select id="year-select">
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
          <option value="2030">2030</option>
        </select>
      </div>

      <button class="btn btn-primary" onclick="loadYear()">üîÑ Carregar Ano</button>
      <button class="btn btn-export" onclick="exportToCSV()">üì• Exportar CSV</button>
      <button class="btn btn-clear" onclick="clearAll()">üóëÔ∏è Limpar Tudo</button>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Total Dias:</span>
          <span class="stat-value" id="total-marcados">0</span>
        </div>
      </div>
    </div>

    <div class="timeline-wrapper">
      <table class="timeline-table" id="timeline-table"></table>
    </div>

    <div class="resumo">
      <h2>üìä Resumo Autom√°tico</h2>
      <table class="resumo-table" id="resumo-table"></table>

      <div class="legend">
        <h3>üé® Legenda</h3>
        <div class="legend-grid">
          <div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #00B050, #009040);"></span><strong>F</strong> = Dia Completo</div>
          <div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #92D050, #7bb854);"></span><strong>M</strong> = Meio-dia Manh√£</div>
          <div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #FFC000, #ffb300);"></span><strong>T</strong> = Meio-dia Tarde</div>
          <div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #DC143C, #B22222);"></span>üî¥ Feriados</div>
          <div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #f0f0f0, #e0e0e0);"></span><strong>üìÖ</strong> = Fins de Semana</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>üéØ Marcar F√©rias</h2>
      <div class="modal-info" id="modal-info">Clique numa op√ß√£o abaixo</div>
      <div class="modal-buttons">
        <button class="btn-f" onclick="setCell('F')">üìÜ F Completo</button>
        <button class="btn-m" onclick="setCell('M')">‚òÄÔ∏è M Manh√£</button>
        <button class="btn-t" onclick="setCell('T')">üåÖ T Tarde</button>
        <button class="btn-clear" onclick="setCell('')">‚ú® Limpar</button>
        <button class="btn-cancel" onclick="closeModal()">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

<!-- FIREBASE CONFIGURATION & SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
  
  // Exp√µe onSnapshot para o script normal
  window.onSnapshot = onSnapshot; 

  const firebaseConfig = {
    apiKey: "AIzaSyBxu7rZvOI2HrfiCImUwwPCu-IILyA5C20",
    authDomain: "mapaferias-12a59.firebaseapp.com",
    projectId: "mapaferias-12a59",
    storageBucket: "mapaferias-12a59.firebasestorage.app",
    messagingSenderId: "706339699788",
    appId: "1:706339699788:web:cc98ae77f3b57a0b7608e9",
    measurementId: "G-BE7LQQ9KF6"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app); // opcional

  const db = getFirestore(app);

  // Expor para o script normal
  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.setDoc = setDoc;

  window.dispatchEvent(new Event("firebase-ready"));
</script>

<!-- TEU APP (script normal) -->
<script>
  const colaboradores = ["Jo√£o Coelho", "Newton Filho", "Ricardo Nunes", "Wallace Lindemberg"];
  let currentYear = 2026;
  let dados = {};
  let feriasAnteriores = {};
  let currentCell = null;
  let saveTimer = null;

    // ---------------------------
    // Feriados Logic (ATUALIZADO)
    // ---------------------------
    function getFeriados(ano) {
      // 1. Feriados Fixos (Nacionais + Santo Ant√≥nio)
      const fixos = [
        { data: `${ano}-01-01`, nome: 'Ano Novo', emoji: 'üéâ' },
        { data: `${ano}-04-25`, nome: 'Dia da Liberdade', emoji: 'üî¥' },
        { data: `${ano}-05-01`, nome: 'Dia do Trabalhador', emoji: 'üî¥' },
        { data: `${ano}-06-10`, nome: 'Dia de Portugal', emoji: 'üáµüáπ' },
        { data: `${ano}-06-13`, nome: 'Santo Ant√≥nio', emoji: 'üêü' }, 
        // S√£o Jo√£o e S√£o Pedro removidos conforme pedido
        { data: `${ano}-08-15`, nome: 'Assun√ß√£o de Nossa Senhora', emoji: 'üî¥' },
        { data: `${ano}-10-05`, nome: 'Implanta√ß√£o da Rep√∫blica', emoji: 'üî¥' },
        { data: `${ano}-11-01`, nome: 'Dia de Todos os Santos', emoji: 'üî¥' },
        { data: `${ano}-12-01`, nome: 'Restaura√ß√£o da Independ√™ncia', emoji: 'üî¥' },
        { data: `${ano}-12-08`, nome: 'Imaculada Concei√ß√£o', emoji: 'üî¥' },
        { data: `${ano}-12-25`, nome: 'Natal', emoji: 'üéÑ' }
      ];

      // 2. C√°lculo da P√°scoa (Algoritmo de Meeus/Jones/Butcher)
      const a = ano % 19;
      const b = Math.floor(ano / 100);
      const c = ano % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const mesPascoa = Math.floor((h + l - 7 * m + 114) / 31);
      const diaPascoa = ((h + l - 7 * m + 114) % 31) + 1;

      const dataPascoa = new Date(ano, mesPascoa - 1, diaPascoa);

      // 3. Calcular Feriados M√≥veis
      const dataSextaSanta = new Date(dataPascoa);
      dataSextaSanta.setDate(dataPascoa.getDate() - 2);

      const dataCorpoDeus = new Date(dataPascoa);
      dataCorpoDeus.setDate(dataPascoa.getDate() + 60);

      const moveis = [
        { data: dataSextaSanta.toISOString().split('T')[0], nome: 'Sexta-feira Santa', emoji: '‚úùÔ∏è' },
        { data: dataPascoa.toISOString().split('T')[0], nome: 'Domingo de P√°scoa', emoji: 'üê∞' },
        { data: dataCorpoDeus.toISOString().split('T')[0], nome: 'Corpo de Deus', emoji: 'üî¥' }
      ];

      // 4. Retornar formatado com a classe gen√©rica 'cell-holiday'
      return [...fixos, ...moveis].map(f => {
         const slug = f.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ /g, '-');
         return {
           ...f,
           classe: `cell-holiday cell-feriado-${slug}`
         };
      });
    }

    // ---------------------------
    // Storage (FIREBASE Backend)
    // ---------------------------
    function scheduleSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          if (!window.db) return;
          const docRef = window.doc(window.db, "ferias", currentYear.toString());
            await window.setDoc(docRef, {
                dados: dados,
                feriasAnteriores: feriasAnteriores
                });
          console.log("Dados salvos no Firebase com sucesso!");
        } catch (e) {
          alert('Falha ao salvar no Firebase: ' + e.message);
        }
      }, 1000); 
    }

    async function initData(ano) {
      currentYear = ano;
      const table = document.getElementById('timeline-table');
      table.innerHTML = '<tr><td>A carregar dados em tempo real...</td></tr>';

      // OUVINTE EM TEMPO REAL (Recomendado para Equipas)
      const docRef = window.doc(window.db, "ferias", ano.toString());
      
      window.onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
           const payload = docSnap.data();
           const loadedDados = payload.dados || {};
           dados = {}; 
           Object.keys(loadedDados).forEach(colab => {
             dados[colab] = loadedDados[colab];
           });
           
           const loadedFeriasAnt = payload.feriasAnteriores || {};
           colaboradores.forEach(colab => {
              if (loadedFeriasAnt[colab] !== undefined) {
                feriasAnteriores[colab] = loadedFeriasAnt[colab];
              }
           });
           renderTimeline();
           updateResumo();
        } else {
           dados = {};
           colaboradores.forEach(c => dados[c] = {});
           renderTimeline();
           updateResumo();
        }
      });
    }

    // ---------------------------
    // Render Timeline (Mantida Original)
    // ---------------------------
    function renderTimeline() {
      const table = document.getElementById('timeline-table');
      table.innerHTML = '';

      const feriados = getFeriados(currentYear);
      const headerRow = document.createElement('tr');
      const headerCell = document.createElement('th');
      headerCell.textContent = 'Colaborador';
      headerRow.appendChild(headerCell);

      let date = new Date(currentYear, 0, 1);
      const endDate = new Date(currentYear, 11, 31);

      while (date <= endDate) {
        const th = document.createElement('th');
        const day = date.getDate();
        const mes = date.toLocaleDateString('pt-PT', { month: 'short' }).toUpperCase();
        const weekday = getDayName(date.getDay()).substring(0, 3).toUpperCase();

        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        const monthAbbr = document.createElement('div');
        monthAbbr.className = 'month-abbr';
        monthAbbr.textContent = mes;
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        const weekdayBottomDiv = document.createElement('div');
        weekdayBottomDiv.className = 'weekday-bottom';
        weekdayBottomDiv.textContent = weekday;

        dayHeader.appendChild(monthAbbr);
        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(weekdayBottomDiv);
        th.appendChild(dayHeader);
        th.title = date.toLocaleDateString('pt-PT');

        const dateStr = date.toISOString().split('T')[0];
        const feriado = feriados.find(f => f.data === dateStr);
        if (feriado) {
          th.title += `\n${feriado.emoji} ${feriado.nome}`;
          th.className = feriado.classe;
        } else if (date.getDay() === 0 || date.getDay() === 6) {
          th.className = 'cell-weekend';
        }
        headerRow.appendChild(th);
        date.setDate(date.getDate() + 1);
      }
      table.appendChild(headerRow);

      colaboradores.forEach(colab => {
        const row = document.createElement('tr');
        const nameCell = document.createElement('td');
        nameCell.textContent = colab;
        row.appendChild(nameCell);

        let d = new Date(currentYear, 0, 1);
        while (d <= endDate) {
          const dateStr = d.toISOString().split('T')[0];
          const cell = document.createElement('td');
          const value = (dados[colab] && dados[colab][dateStr]) ? dados[colab][dateStr] : '';

          if (value === 'F') cell.className = 'cell-f';
          else if (value === 'M') cell.className = 'cell-m';
          else if (value === 'T') cell.className = 'cell-t';
          else {
            const feriado = feriados.find(f => f.data === dateStr);
            if (feriado) {
              cell.className = feriado.classe;
              cell.title = `${feriado.emoji} ${feriado.nome}`;
            } else if (d.getDay() === 0 || d.getDay() === 6) {
              cell.className = 'cell-weekend';
            } else {
              cell.className = 'cell-empty';
            }
          }
          cell.textContent = value || '';

          cell.onclick = function() {
            const cellDate = new Date(dateStr + 'T00:00:00');
            currentCell = { colab, dateStr };
            const feriado = feriados.find(f => f.data === dateStr);
            const info = `üìÖ ${cellDate.toLocaleDateString('pt-PT')} (${getDayName(cellDate.getDay())})<br>` +
              `Colaborador: ${colab}<br>Valor atual: ${value || 'vazio'}<br>` +
              `${feriado ? (feriado.emoji + ' FERIADO: ' + feriado.nome) : ''}`;
            document.getElementById('modal-info').innerHTML = info;
            document.getElementById('modal').style.display = 'flex';
          };
          row.appendChild(cell);
          d.setDate(d.getDate() + 1);
        }
        table.appendChild(row);
      });
    }

    // ---------------------------
    // Resumo Logic (Mantida Original)
    // ---------------------------
    function updateResumo() {
      const table = document.getElementById('resumo-table');
      table.innerHTML = '';
      const headerRow = document.createElement('tr');
      ['Colaborador', 'F√©rias Ant. <span style="font-size:12px">(clicar)</span>', 'F√©rias ' + currentYear, 'Total Disp.', 'Gozadas (F)', 'Marcadas (M+T)', 'Por Marcar'].forEach(header => {
        const th = document.createElement('th');
        th.innerHTML = header;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      let totalMarcados = 0;

      colaboradores.forEach(colab => {
        const values = Object.values(dados[colab] || {});
        const gozadasF = values.filter(v => v === 'F').length;
        const marcadasMT = values.filter(v => v === 'M' || v === 'T').length * 0.5;
        const ferAnt = feriasAnteriores[colab] || 0;
        const ferAno = 22;
        const totalDisp = ferAnt + ferAno;
        const porMarcar = totalDisp - gozadasF - marcadasMT;
        totalMarcados += gozadasF + marcadasMT;

        const row = document.createElement('tr');
        const cells = [colab, ferAnt, ferAno, totalDisp, gozadasF, marcadasMT.toFixed(1), porMarcar.toFixed(1)];
        cells.forEach((cellValue, idx) => {
          const td = document.createElement('td');
          td.textContent = cellValue;
          if (idx === 1) {
            td.className = 'cell-editable';
            td.onclick = function() {
              const novoValor = prompt('F√©rias Anteriores para ' + colab + ':', ferAnt);
              if (novoValor !== null && !isNaN(novoValor) && Number(novoValor) >= 0) {
                feriasAnteriores[colab] = parseFloat(novoValor);
                scheduleSave();
                updateResumo();
              }
            };
          } else if (idx >= 3) td.className = 'cell-calc';
          row.appendChild(td);
        });
        table.appendChild(row);
      });
      document.getElementById('total-marcados').textContent = totalMarcados.toFixed(1);
    }

    // ---------------------------
    // Actions & Events
    // ---------------------------
    function setCell(value) {
      if (!currentCell) return;
      if (!dados[currentCell.colab]) dados[currentCell.colab] = {};
      dados[currentCell.colab][currentCell.dateStr] = value;
      scheduleSave();
      renderTimeline();
      updateResumo();
      closeModal();
    }
    
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function clearAll() {
      if (!confirm('Limpar todos os dados deste ano?')) return;
      Object.keys(dados).forEach(colab => { Object.keys(dados[colab]).forEach(dateStr => { dados[colab][dateStr] = ''; }); });
      Object.keys(feriasAnteriores).forEach(colab => (feriasAnteriores[colab] = 0));
      scheduleSave();
      renderTimeline();
      updateResumo();
    }

    function exportToCSV() {
      let csv = 'Colaborador,F√©rias Ant.,F√©rias ' + currentYear + ',Total,Gozadas F,Marcadas M+T,Por Marcar\n';
      colaboradores.forEach(colab => {
        const values = Object.values(dados[colab] || {});
        const gozadasF = values.filter(v => v === 'F').length;
        const marcadasMT = values.filter(v => v === 'M' || v === 'T').length * 0.5;
        const ferAnt = feriasAnteriores[colab] || 0;
        const ferAno = 22;
        const totalDisp = ferAnt + ferAno;
        const porMarcar = totalDisp - gozadasF - marcadasMT;
        csv += `${colab},${ferAnt},${ferAno},${totalDisp},${gozadasF},${marcadasMT.toFixed(1)},${porMarcar.toFixed(1)}\n`;
      });
      const link = document.createElement('a');
      link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      link.download = `Mapa_Ferias_${currentYear}.csv`;
      link.click();
    }

    function getDayName(day) { return ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][day]; }
    function loadYear() { const ano = parseInt(document.getElementById('year-select').value, 10); initData(ano); }

    // Init Logic
    window.addEventListener('firebase-ready', async () => {
     await initData(2026);
    });
    window.onload = function() {
      // Setup UI listeners
      document.getElementById('year-select').addEventListener('change', async function() {
        const ano = parseInt(this.value, 10);
        await initData(ano);
      });
      window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) modal.style.display = 'none';
      };
    };
  </script>
</body>
</html>
