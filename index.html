<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de F√©rias - Auchan & Closer (CORS Livre)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .year-selector select {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }

        .timeline-container {
            padding: 30px;
            overflow-x: auto;
        }

        .timeline {
            display: grid;
            grid-template-columns: 200px repeat(12, 1fr);
            gap: 2px;
            min-width: 1200px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .timeline-header {
            background: linear-gradient(45deg, #1976D2, #2196F3);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .timeline-header:first-child {
            background: linear-gradient(45deg, #424242, #616161);
        }

        .timeline-cell {
            padding: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 12px;
        }

        .timeline-cell:hover {
            background: #f5f5f5;
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .collaborator-name {
            background: linear-gradient(45deg, #424242, #616161);
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 15px 10px;
        }

        .ferias {
            background: linear-gradient(45deg, #4CAF50, #66BB6A) !important;
            color: white !important;
            font-weight: bold;
        }

        .ferias-anteriores {
            background: linear-gradient(45deg, #FF9800, #FFB74D) !important;
            color: white !important;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #f44336;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #4caf50;
        }

        .resumo {
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
        }

        .resumo h3 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .resumo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .resumo-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            color: #1565C0;
        }

        .ferias-anteriores-control {
            margin: 20px 0;
            padding: 20px;
            background: #fff3e0;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }

        .ferias-anteriores-control h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .ferias-anteriores-control input {
            padding: 8px 12px;
            border: 2px solid #ff9800;
            border-radius: 4px;
            margin-right: 10px;
            width: 80px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .timeline {
                grid-template-columns: 150px repeat(12, 1fr);
                font-size: 10px;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        .hidden-form {
            display: none;
        }

        .jsonp-callback {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóìÔ∏è Mapa de F√©rias</h1>
            <p>Auchan & Closer - Sistema de Gest√£o de F√©rias</p>
        </div>

        <div class="controls">
            <div class="year-selector">
                <label for="anoSelect"><strong>Ano:</strong></label>
                <select id="anoSelect">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
                <button class="btn btn-primary" onclick="carregarAno()">üìÖ Carregar Ano</button>
            </div>
            
            <div>
                <button class="btn btn-success" onclick="salvarDados()">üíæ Salvar Dados</button>
                <button class="btn btn-warning" onclick="exportarCSV()">üìä Exportar CSV</button>
            </div>
        </div>

        <div id="feriasAnterioresContainer" class="ferias-anteriores-control">
            <h4>üîÑ F√©rias Anteriores</h4>
            <label>Total de dias de f√©rias de anos anteriores:</label>
            <input type="number" id="feriasAnterioresInput" value="0" min="0" max="50">
            <button class="btn btn-primary" onclick="atualizarFeriasAnteriores()">Atualizar</button>
        </div>

        <div id="mensagem"></div>
        <div id="resumo" class="resumo" style="display: none;">
            <h3>üìà Resumo de F√©rias</h3>
            <div id="resumoContent"></div>
        </div>

        <div id="timelineContainer" class="timeline-container">
            <div id="loading" class="loading" style="display: none;">
                ‚è≥ A carregar dados...
            </div>
            <div id="timeline" class="timeline"></div>
        </div>
    </div>

    <!-- Formul√°rio oculto para evitar CORS -->
    <form id="hiddenForm" class="hidden-form" method="POST" target="hiddenIframe">
        <input type="hidden" name="data" id="formData">
    </form>
    <iframe name="hiddenIframe" class="hidden-form"></iframe>

    <!-- JSONP Callback -->
    <div id="jsonpCallback" class="jsonp-callback"></div>

    <script>
        // Configura√ß√µes
        const API_BASE = 'https://script.google.com/macros/s/AKfycbz-VQsQCCvGT_gxNEw_0GNAzCK9IHD-038ImbgHRdvsDxadqTbOO1EEv8yVmoi9MU78/exec';
        let dadosAtuais = {};
        let colaboradores = [
            'Alice Santos', 'Bruno Costa', 'Carla Mendes', 'David Silva', 'Eva Rodrigues',
            'Fabio Oliveira', 'Gabriela Ferreira', 'Hugo Pereira', 'In√™s Lima', 'Jo√£o Santos',
            'Karla Costa', 'Lu√≠s Mendes', 'Marta Silva', 'Nuno Rodrigues', 'Olivia Ferreira'
        ];
        let feriasAnteriores = 0;

        // Meses do ano
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

        // Inicializa√ß√£o
        window.onload = function() {
            console.log('üöÄ Sistema de Mapa de F√©rias iniciado (CORS Livre)');
            carregarAno();
        };

        // Fun√ß√£o para carregar dados usando JSONP (evita CORS)
        function carregarDadosJSONP(ano, callback) {
            console.log('üì° Carregando dados via JSONP para o ano:', ano);
            
            // Criar fun√ß√£o callback global
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.head.removeChild(script);
                callback(data);
            };

            // Criar script tag para JSONP
            const script = document.createElement('script');
            script.src = API_BASE + '?ano=' + ano + '&callback=' + callbackName;
            script.onerror = function() {
                delete window[callbackName];
                callback({success: false, error: 'Erro na conex√£o com o servidor'});
            };
            document.head.appendChild(script);
        }

        // Carregar ano
        function carregarAno() {
            const ano = document.getElementById('anoSelect').value;
            console.log('üìÖ Carregando ano:', ano);
            
            mostrarLoading(true);
            mostrarMensagem('');

            // Usar JSONP para evitar CORS
            carregarDadosJSONP(ano, function(resposta) {
                mostrarLoading(false);
                
                if (resposta.success) {
                    console.log('‚úÖ Dados carregados com sucesso:', resposta.data);
                    dadosAtuais = resposta.data || {};
                    feriasAnteriores = resposta.feriasAnteriores || 0;
                    
                    // Atualizar interface
                    document.getElementById('feriasAnterioresInput').value = feriasAnteriores;
                    renderizarTimeline();
                    atualizarResumo();
                    mostrarMensagem('‚úÖ Dados carregados com sucesso!', 'success');
                } else {
                    console.log('‚ö†Ô∏è Erro ao carregar dados:', resposta.error);
                    // Usar dados locais se falhar
                    dadosAtuais = {};
                    renderizarTimeline();
                    atualizarResumo();
                    mostrarMensagem('‚ö†Ô∏è Usando dados locais. Clique em "Salvar Dados" para sincronizar.', 'error');
                }
            });
        }

        // Renderizar timeline
        function renderizarTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            // Cabe√ßalho
            const headerCol = document.createElement('div');
            headerCol.className = 'timeline-header';
            headerCol.textContent = 'Colaborador';
            timeline.appendChild(headerCol);

            meses.forEach(mes => {
                const header = document.createElement('div');
                header.className = 'timeline-header';
                header.textContent = mes;
                timeline.appendChild(header);
            });

            // Linhas de colaboradores
            colaboradores.forEach(colaborador => {
                const nomeCell = document.createElement('div');
                nomeCell.className = 'timeline-cell collaborator-name';
                nomeCell.textContent = colaborador;
                timeline.appendChild(nomeCell);

                meses.forEach((mes, mesIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'timeline-cell';
                    cell.dataset.colaborador = colaborador;
                    cell.dataset.mes = mesIndex;
                    cell.dataset.ano = document.getElementById('anoSelect').value;
                    
                    // Verificar estado atual
                    const key = `${colaborador}-${mesIndex}`;
                    if (dadosAtuais[key]) {
                        cell.classList.add(dadosAtuais[key]);
                        cell.textContent = dadosAtuais[key] === 'ferias' ? 'F√âRIAS' : 'F√âRIAS ANT';
                    }

                    cell.onclick = function() { alternarCelula(this); };
                    timeline.appendChild(cell);
                });
            });
        }

        // Alternar estado da c√©lula
        function alternarCelula(cell) {
            const colaborador = cell.dataset.colaborador;
            const mes = cell.dataset.mes;
            const key = `${colaborador}-${mes}`;

            if (cell.classList.contains('ferias')) {
                cell.classList.remove('ferias');
                cell.classList.add('ferias-anteriores');
                cell.textContent = 'F√âRIAS ANT';
                dadosAtuais[key] = 'ferias-anteriores';
            } else if (cell.classList.contains('ferias-anteriores')) {
                cell.classList.remove('ferias-anteriores');
                cell.textContent = '';
                delete dadosAtuais[key];
            } else {
                cell.classList.add('ferias');
                cell.textContent = 'F√âRIAS';
                dadosAtuais[key] = 'ferias';
            }

            atualizarResumo();
        }

        // Atualizar resumo
        function atualizarResumo() {
            const totalFerias = Object.values(dadosAtuais).filter(tipo => tipo === 'ferias').length;
            const totalFeriasAnteriores = Object.values(dadosAtuais).filter(tipo => tipo === 'ferias-anteriores').length;
            const totalGeral = totalFerias + feriasAnteriores;

            const resumoContent = document.getElementById('resumoContent');
            resumoContent.innerHTML = `
                <div class="resumo-item">
                    <span>F√©rias do Ano Atual:</span>
                    <span>${totalFerias} dias</span>
                </div>
                <div class="resumo-item">
                    <span>F√©rias Anteriores:</span>
                    <span>${feriasAnteriores} dias</span>
                </div>
                <div class="resumo-item">
                    <span>Total de F√©rias:</span>
                    <span>${totalGeral} dias</span>
                </div>
            `;

            document.getElementById('resumo').style.display = 'block';
        }

        // Atualizar f√©rias anteriores
        function atualizarFeriasAnteriores() {
            feriasAnteriores = parseInt(document.getElementById('feriasAnterioresInput').value) || 0;
            atualizarResumo();
            mostrarMensagem('‚úÖ F√©rias anteriores atualizadas!', 'success');
        }

        // Salvar dados usando formul√°rio oculto (evita CORS)
        function salvarDados() {
            console.log('üíæ Salvando dados...');
            mostrarMensagem('');

            const ano = document.getElementById('anoSelect').value;
            const dadosParaSalvar = {
                ano: ano,
                data: dadosAtuais,
                feriasAnteriores: feriasAnteriores,
                colaboradores: colaboradores
            };

            // Usar formul√°rio oculto para evitar CORS
            try {
                const form = document.getElementById('hiddenForm');
                const formData = document.getElementById('formData');
                
                formData.value = JSON.stringify(dadosParaSalvar);
                form.action = API_BASE;
                form.submit();

                mostrarMensagem('‚úÖ Dados enviados para salvamento! (Usando m√©todo CORS-livre)', 'success');
                
                // Limpar formul√°rio ap√≥s envio
                setTimeout(() => {
                    form.reset();
                }, 1000);

            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarMensagem('‚ùå Erro ao salvar dados. Tentando m√©todo alternativo...', 'error');
                
                // Fallback: salvar localmente
                salvarLocalmente();
            }
        }

        // Salvar localmente (fallback)
        function salvarLocalmente() {
            try {
                const dadosParaSalvar = {
                    ano: document.getElementById('anoSelect').value,
                    data: dadosAtuais,
                    feriasAnteriores: feriasAnteriores,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('mapaFerias_backup', JSON.stringify(dadosParaSalvar));
                mostrarMensagem('‚úÖ Dados salvos localmente! (Backup criado)', 'success');
            } catch (error) {
                console.error('Erro ao salvar localmente:', error);
                mostrarMensagem('‚ùå Erro ao salvar dados localmente.', 'error');
            }
        }

        // Exportar CSV
        function exportarCSV() {
            console.log('üìä Exportando CSV...');
            
            let csv = 'Colaborador,' + meses.join(',') + '\n';
            
            colaboradores.forEach(colaborador => {
                let linha = colaborador;
                meses.forEach((mes, mesIndex) => {
                    const key = `${colaborador}-${mesIndex}`;
                    const estado = dadosAtuais[key] || '';
                    linha += ',' + (estado ? (estado === 'ferias' ? 'F√âRIAS' : 'F√âRIAS_ANT') : '');
                });
                csv += linha + '\n';
            });

            // Baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mapa_ferias_${document.getElementById('anoSelect').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            mostrarMensagem('‚úÖ CSV exportado com sucesso!', 'success');
        }

        // Fun√ß√µes auxiliares
        function mostrarLoading(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
        }

        function mostrarMensagem(mensagem, tipo = '') {
            const mensagemDiv = document.getElementById('mensagem');
            if (mensagem) {
                mensagemDiv.className = tipo;
                mensagemDiv.innerHTML = mensagem;
                mensagemDiv.style.display = 'block';
                
                if (tipo === 'success') {
                    setTimeout(() => {
                        mensagemDiv.style.display = 'none';
                    }, 3000);
                }
            } else {
                mensagemDiv.style.display = 'none';
            }
        }

        // Verificar dados salvos localmente ao carregar
        function verificarBackupLocal() {
            const backup = localStorage.getItem('mapaFerias_backup');
            if (backup) {
                try {
                    const dados = JSON.parse(backup);
                    if (dados.ano === document.getElementById('anoSelect').value) {
                        mostrarMensagem('üí° Dados locais encontrados. Clique em "Carregar Ano" para sincronizar.', 'success');
                    }
                } catch (e) {
                    console.log('Sem backup local v√°lido');
                }
            }
        }

        // Verificar backup ao carregar
        setTimeout(verificarBackupLocal, 2000);
    </script>
</body>
</html>
