<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de F√©rias - Auchan & Closer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 100%; background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1F4E78 0%, #2d5a8c 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .controls { padding: 25px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, #00B050, #009040); color: white; }
        .btn-export { background: linear-gradient(135deg, #4472C4, #2d5aa6); color: white; }
        .timeline-table { border-collapse: collapse; width: 100%; font-size: 10px; }
        .timeline-table th { background: linear-gradient(135deg, #1F4E78, #2d5a8c); color: white; padding: 8px 4px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 20; }
        .timeline-table td { border-right: 1px solid #eee; padding: 4px 2px; text-align: center; cursor: pointer; min-width: 38px; height: 38px; font-weight: bold; font-size: 11px; }
        .cell-f { background: linear-gradient(135deg, #00B050, #009040); color: white; }
        .cell-m { background: linear-gradient(135deg, #92D050, #7bb854); color: white; }
        .cell-t { background: linear-gradient(135deg, #FFC000, #ffb300); color: white; }
        .cell-weekend { background: linear-gradient(135deg, #f0f0f0, #e0e0e0); color: #666; }
        .resumo { padding: 30px; background: #f8f9fa; }
        .resumo-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
        .resumo-table th { background: linear-gradient(135deg, #4472C4, #2d5aa6); color: white; padding: 15px; text-align: left; }
        .resumo-table td { border-bottom: 1px solid #eee; padding: 15px; text-align: center; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 450px; }
        .modal-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 25px; }
        .legend { background: white; padding: 25px; border-radius: 10px; border: 2px solid #e0e0e0; margin-top: 25px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Mapa de F√©rias</h1>
            <p>Time Line Interativo - Auchan & Closer Team</p>
        </div>

        <div class="controls">
            <select id="year-select">
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
            </select>
            <button class="btn btn-primary" onclick="loadYear()">üîÑ Carregar Ano</button>
            <button class="btn btn-export" onclick="exportToCSV()">üì• Exportar CSV</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="timeline-table" id="timeline-table"></table>
        </div>

        <div class="resumo">
            <h2>üìä Resumo Autom√°tico</h2>
            <table class="resumo-table" id="resumo-table"></table>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2>üéØ Marcar F√©rias</h2>
            <div class="modal-info" id="modal-info"></div>
            <div class="modal-buttons">
                <button class="btn" style="background: linear-gradient(135deg, #00B050, #009040); color: white;" onclick="setCell('F')">üìÜ F Completo</button>
                <button class="btn" style="background: linear-gradient(135deg, #92D050, #7bb854); color: white;" onclick="setCell('M')">‚òÄÔ∏è M Manh√£</button>
                <button class="btn" style="background: linear-gradient(135deg, #FFC000, #ffb300); color: white;" onclick="setCell('T')">üåÖ T Tarde</button>
                <button class="btn" style="background: #999; color: white;" onclick="setCell('')">‚ú® Limpar</button>
                <button class="btn" style="background: #FF6B6B; color: white; grid-column: 1 / -1;" onclick="closeModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // URL do Apps Script Web App - ATUALIZE COM A SUA URL
        const API_BASE = 'https://script.google.com/macros/s/AKfycbz-VQsQCCvGT_gxNEw_0GNAzCK9IHD-038ImbgHRdvsDxadqTbOO1EEv8yVmoi9MU78/exec';

        const colaboradores = ["Jo√£o Coelho", "Newton Filho", "Ricardo Nunes", "Wallace Lindemberg"];
        let currentYear = 2026;
        let dados = {};
        let feriasAnteriores = {};
        let currentCell = null;

        function getFeriados(ano) {
            // Feriados fixos de Portugal
            const feriados = [
                {data: `${ano}-01-01`, nome: 'Ano Novo', classe: 'cell-weekend'},
                {data: `${ano}-04-25`, nome: 'Liberdade', classe: 'cell-weekend'},
                {data: `${ano}-05-01`, nome: 'Trabalhador', classe: 'cell-weekend'},
                {data: `${ano}-06-10`, nome: 'Portugal', classe: 'cell-weekend'},
                {data: `${ano}-08-15`, nome: 'Assun√ß√£o', classe: 'cell-weekend'},
                {data: `${ano}-10-05`, nome: 'Rep√∫blica', classe: 'cell-weekend'},
                {data: `${ano}-11-01`, nome: 'Todos Santos', classe: 'cell-weekend'},
                {data: `${ano}-12-01`, nome: 'Restaura√ß√£o', classe: 'cell-weekend'},
                {data: `${ano}-12-08`, nome: 'Imaculada', classe: 'cell-weekend'},
                {data: `${ano}-12-25`, nome: 'Natal', classe: 'cell-weekend'}
            ];
            return feriados;
        }

        async function loadFromStorage(ano) {
            try {
                console.log('Carregando dados do ano:', ano);
                const response = await fetch(`${API_BASE}?ano=${ano}`);
                const result = await response.json();
                
                if (result.dados) {
                    dados = JSON.parse(result.dados);
                } else {
                    dados = {};
                }
                
                if (result.feriasAnteriores) {
                    feriasAnteriores = JSON.parse(result.feriasAnteriores);
                } else {
                    feriasAnteriores = {};
                }
                
                // Inicializar estrutura se necess√°rio
                colaboradores.forEach(colab => {
                    if (!dados[colab]) dados[colab] = {};
                    if (!feriasAnteriores[colab]) feriasAnteriores[colab] = 0;
                });
                
                console.log('Dados carregados com sucesso');
            } catch (error) {
                console.error('Erro ao carregar:', error);
                // Inicializar com dados vazios
                dados = {};
                feriasAnteriores = {};
                colaboradores.forEach(colab => {
                    dados[colab] = {};
                    feriasAnteriores[colab] = 0;
                });
            }
        }

        async function saveDay(ano, colaborador, dataStr, tipo) {
            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ano: ano,
                        colaborador: colaborador,
                        dataStr: dataStr,
                        tipo: tipo
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('Erro ao salvar:', result.error);
                    alert('Erro ao salvar: ' + result.error);
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                alert('Erro ao salvar dados: ' + error.message);
            }
        }

        async function saveFeriasAnteriores(ano, colaborador, valor) {
            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ano: ano,
                        colaborador: colaborador,
                        feriasAnteriores: valor
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('Erro ao salvar f√©rias anteriores:', result.error);
                    alert('Erro ao salvar f√©rias anteriores: ' + result.error);
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                alert('Erro ao salvar f√©rias anteriores: ' + error.message);
            }
        }

        async function initData(ano) {
            currentYear = ano;
            await loadFromStorage(ano);
            renderTimeline();
            updateResumo();
        }

        function renderTimeline() {
            const table = document.getElementById('timeline-table');
            table.innerHTML = '';

            const feriados = getFeriados(currentYear);

            // Cabe√ßalho
            const headerRow = document.createElement('tr');
            const headerCell = document.createElement('th');
            headerCell.textContent = 'Colaborador';
            headerRow.appendChild(headerCell);

            const diasNoAno = [];
            let date = new Date(currentYear, 0, 1);
            const endDate = new Date(currentYear, 11, 31);

            while (date <= endDate) {
                const th = document.createElement('th');
                const day = date.getDate();
                const month = date.toLocaleDateString('pt-PT', {month: 'short'});
                th.innerHTML = `<div style="font-size: 8px;">${month}</div><div>${day}</div>`;
                th.title = date.toLocaleDateString('pt-PT');
                
                const dateStr = date.toISOString().split('T')[0];
                const feriado = feriados.find(f => f.data === dateStr);
                if (feriado) {
                    th.className = feriado.classe;
                } else if (date.getDay() === 0 || date.getDay() === 6) {
                    th.className = 'cell-weekend';
                }
                
                diasNoAno.push(dateStr);
                headerRow.appendChild(th);
                date.setDate(date.getDate() + 1);
            }
            table.appendChild(headerRow);

            // Dados dos colaboradores
            colaboradores.forEach(colab => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = colab;
                nameCell.style.cssText = 'position: sticky; left: 0; background: linear-gradient(135deg, #4472C4, #5981d6); color: white; font-weight: bold; z-index: 10;';
                row.appendChild(nameCell);

                diasNoAno.forEach(dateStr => {
                    const cell = document.createElement('td');
                    const value = dados[colab] && dados[colab][dateStr] ? dados[colab][dateStr] : '';
                    
                    if (value === 'F') cell.className = 'cell-f';
                    else if (value === 'M') cell.className = 'cell-m';
                    else if (value === 'T') cell.className = 'cell-t';
                    else {
                        const feriado = feriados.find(f => f.data === dateStr);
                        if (feriado) {
                            cell.className = feriado.classe;
                        } else if (new Date(dateStr).getDay() === 0 || new Date(dateStr).getDay() === 6) {
                            cell.className = 'cell-weekend';
                        }
                    }

                    cell.textContent = value;
                    cell.onclick = () => {
                        currentCell = {colab, dateStr};
                        const cellDate = new Date(dateStr + 'T00:00:00');
                        document.getElementById('modal-info').innerHTML = `
                            üìÖ ${cellDate.toLocaleDateString('pt-PT')}<br>
                            Colaborador: ${colab}<br>
                            Valor atual: ${value || 'vazio'}
                        `;
                        document.getElementById('modal').style.display = 'flex';
                    };
                    
                    row.appendChild(cell);
                });
                table.appendChild(row);
            });
        }

        function updateResumo() {
            const table = document.getElementById('resumo-table');
            table.innerHTML = '<tr><th>Colaborador</th><th>F√©rias Ant.</th><th>F√©rias 2026</th><th>Total</th><th>Gozadas</th><th>Marcadas</th><th>Por Marcar</th></tr>';

            colaboradores.forEach(colab => {
                const gozadasF = Object.values(dados[colab] || {}).filter(v => v === 'F').length;
                const marcadasMT = Object.values(dados[colab] || {}).filter(v => v === 'M' || v === 'T').length * 0.5;
                const ferAnt = feriasAnteriores[colab] || 0;
                const ferAno = 22;
                const totalDisp = ferAnt + ferAno;
                const porMarcar = totalDisp - gozadasF - marcadasMT;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${colab}</td>
                    <td style="cursor: pointer; background: #FFF2CC;" onclick="editFeriasAnteriores('${colab}', ${ferAnt})">${ferAnt}</td>
                    <td>${ferAno}</td>
                    <td style="background: #E7E6E6;">${totalDisp}</td>
                    <td style="background: #E7E6E6;">${gozadasF}</td>
                    <td style="background: #E7E6E6;">${marcadasMT.toFixed(1)}</td>
                    <td style="background: #E7E6E6;">${porMarcar.toFixed(1)}</td>
                `;
                table.appendChild(row);
            });
        }

        function editFeriasAnteriores(colab, valorAtual) {
            const novoValor = prompt(`F√©rias Anteriores para ${colab}:`, valorAtual);
            if (novoValor !== null && !isNaN(novoValor) && novoValor >= 0) {
                feriasAnteriores[colab] = parseFloat(novoValor);
                saveFeriasAnteriores(currentYear, colab, parseFloat(novoValor));
                updateResumo();
            }
        }

        async function setCell(value) {
            if (currentCell) {
                if (!dados[currentCell.colab]) dados[currentCell.colab] = {};
                dados[currentCell.colab][currentCell.dateStr] = value;
                
                await saveDay(currentYear, currentCell.colab, currentCell.dateStr, value);
                
                renderTimeline();
                updateResumo();
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function exportToCSV() {
            let csv = 'Colaborador,F√©rias Ant.,F√©rias 2026,Total,Gozadas,Marcadas,Por Marcar\n';
            colaboradores.forEach(colab => {
                const gozadasF = Object.values(dados[colab] || {}).filter(v => v === 'F').length;
                const marcadasMT = Object.values(dados[colab] || {}).filter(v => v === 'M' || v === 'T').length * 0.5;
                const ferAnt = feriasAnteriores[colab] || 0;
                const ferAno = 22;
                const totalDisp = ferAnt + ferAno;
                const porMarcar = totalDisp - gozadasF - marcadasMT;

                csv += `${colab},${ferAnt},${ferAno},${totalDisp},${gozadasF},${marcadasMT.toFixed(1)},${porMarcar.toFixed(1)}\n`;
            });

            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `Mapa_Ferias_${currentYear}.csv`;
            link.click();
        }

        function loadYear() {
            const ano = parseInt(document.getElementById('year-select').value);
            initData(ano);
        }

        // Inicializa√ß√£o
        window.onload = async function() {
            await initData(2026);

            document.getElementById('year-select').addEventListener('change', async function() {
                const ano = parseInt(this.value);
                await initData(ano);
            });

            window.onclick = function(event) {
                const modal = document.getElementById('modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        };
    </script>
</body>
</html>
